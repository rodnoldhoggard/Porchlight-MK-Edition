<!DOCTYPE html>
<html>
<head>
    <title>PORCHLIGHT</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; touch-action: none; }
        
        /* THE MENU - Simple and front-facing */
        #menu { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; flex-direction: column; justify-content: center; 
            align-items: center; background: #000;
            z-index: 9999; color: white; text-align: center;
        }

        h1 { font-size: 80px; margin: 0; color: #fff; text-shadow: 0 0 20px #ff0000; }
        
        .start-btn { 
            margin-top: 40px; padding: 25px 80px; font-size: 28px; 
            background: #ff0000; color: white; border: none; 
            cursor: pointer; border-radius: 10px;
            font-weight: bold; text-transform: uppercase;
        }

        #ui { position: absolute; top: 20px; left: 20px; color: white; display: none; z-index: 100; font-size: 24px; font-family: monospace; }
        #fatality-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: red; opacity: 0; pointer-events: none; z-index: 500; }
    </style>
</head>
<body>

    <div id="fatality-overlay"></div>

    <div id="menu">
        <h1>PORCHLIGHT</h1>
        <p>TAP ANYWHERE OR PRESS A TO START</p>
        <button id="start-node" class="start-btn">START GAME</button>
    </div>

    <div id="ui">LVL: <span id="lvl-count">1</span></div>
    
    <script type="module">
        import * as THREE from 'https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.module.min.js';

        let gameActive = false;
        let currentLevel = 1;
        const obstacles = [];

        // --- ENGINE SETUP ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        const player = new THREE.Mesh(new THREE.BoxGeometry(0.7,0.7,0.7), new THREE.MeshStandardMaterial({color: 0xffffff}));
        scene.add(player);
        const pLight = new THREE.PointLight(0xffffff, 100, 100);
        scene.add(pLight);
        scene.add(new THREE.AmbientLight(0xffffff, 0.3));

        const goal = new THREE.Mesh(new THREE.SphereGeometry(0.5), new THREE.MeshStandardMaterial({color: 0xffd700}));
        scene.add(goal);

        // --- THE "FORCE" START LOGIC ---
        function startGame() {
            if (gameActive) return;
            console.log("Game Starting...");
            gameActive = true;
            document.getElementById('menu').style.display = 'none';
            document.getElementById('ui').style.display = 'block';
            loadLevel(1);
        }

        // 1. Listen to the button
        document.getElementById('start-node').addEventListener('click', startGame);
        
        // 2. Listen to the WHOLE screen (for mobile users who can't hit the button)
        window.addEventListener('touchstart', startGame);
        
        // 3. Listen to the keyboard (Enter or Space)
        window.addEventListener('keydown', (e) => {
            if(e.code === 'Enter' || e.code === 'Space') startGame();
        });

        function loadLevel(num) {
            currentLevel = num;
            document.getElementById('lvl-count').innerText = num;
            player.position.set(0, 0, 0);
            goal.position.set(0, 0, -num * 15);
            obstacles.forEach(o => scene.remove(o));
            obstacles.length = 0;
            for(let i=0; i < num * 5; i++) {
                const obs = new THREE.Mesh(new THREE.BoxGeometry(2, 2, 2), new THREE.MeshStandardMaterial({color: 0x660000}));
                obs.position.set(Math.random() * 16 - 8, 0, -Math.random() * (num * 15) - 3);
                scene.add(obs);
                obstacles.push(obs);
            }
        }

        const keys = {};
        window.onkeydown = (e) => keys[e.code] = true;
        window.onkeyup = (e) => keys[e.code] = false;

        function update() {
            // Controller Check
            const gp = navigator.getGamepads()[0];
            if (!gameActive && gp && gp.buttons.some(b => b.pressed)) startGame();

            if (gameActive) {
                let speed = 0.2;
                let mx = 0, mz = 0;

                if (keys['ArrowUp'] || keys['KeyW']) mz -= speed;
                if (keys['ArrowDown'] || keys['KeyS']) mz += speed;
                if (keys['ArrowLeft'] || keys['KeyA']) mx -= speed;
                if (keys['ArrowRight'] || keys['KeyD']) mx += speed;

                if (gp) {
                    if (Math.abs(gp.axes[0]) > 0.1) mx += gp.axes[0] * speed;
                    if (Math.abs(gp.axes[1]) > 0.1) mz += gp.axes[1] * speed;
                }

                player.position.x += mx;
                player.position.z += mz;
                camera.position.set(player.position.x, 6, player.position.z + 9);
                camera.lookAt(player.position);
                pLight.position.set(player.position.x, 2, player.position.z);

                if (player.position.distanceTo(goal.position) < 1.3) loadLevel(currentLevel + 1);
                obstacles.forEach(o => {
                    if (player.position.distanceTo(o.position) < 1.4) loadLevel(1);
                });
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            update();
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>